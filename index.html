<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportage Photos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="/manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #04243c;
            --primary: #19484e;
            --primary-light: #2a6e7a;
            --accent: #5fa586;
            --accent-light: #8fc9b3;
            --light: #f8f9fa;
            --dark: #333;
            --gray: #7f8c8d;
            --light-gray: #ecf0f1;
            --error: #e74c3c;
            --warning: #f39c12;
            --success: #27ae60;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-light));
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
            line-height: 1.6;
        }

        /* [Tous vos autres styles CSS - conservez tout] */
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15); overflow: hidden; position: relative; border: 1px solid rgba(0, 0, 0, 0.05); }
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; padding: 30px; text-align: center; position: relative; overflow: hidden; }
        /* ... [Continuez avec tous vos styles] ... */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://upload.wikimedia.org/wikipedia/fr/0/0c/Equans_Logo.png" alt="Logo Equans" class="logo">
            </div>
            <h1><i class="fas fa-camera"></i> Reportage Photos </h1>
            <p>Organiser les photos par catégorie et générer des rapports PDF</p>
        </div>

        <div class="content">
            <!-- Section informations du projet -->
            <div class="project-info-section">
                <h3 class="project-info-title"><i class="fas fa-info-circle"></i> Informations du projet</h3>
                <div class="project-info-grid">
                    <div class="info-field">
                        <label for="affaire"><i class="fas fa-building"></i> Affaire :</label>
                        <input type="text" id="affaire" placeholder="Ex: GLOBAL SWITCH - CAMPUS PARIS CLICHY - PAR_E">
                    </div>
                    <!-- [Conservez tous vos autres champs de formulaire] -->
                </div>
            </div>

            <!-- [Conservez toutes vos autres sections HTML] -->
            <div class="upload-section" id="uploadSection">...</div>
            <div class="tabs">...</div>
            <div id="categoriesTab" class="tab-content active">...</div>
            <div id="photosTab" class="tab-content">...</div>
            <div class="export-section" id="exportSection" style="display: none;">...</div>
            <div class="loading" id="loadingSection">...</div>
        </div>
    </div>

    <!-- Modal pour la caméra -->
    <div id="cameraModal" class="camera-modal">...</div>

    <script>
        // Variables globales
        let photos = [];
        let photoCounter = 0;
        let activeTab = 'categories';
        let currentSort = 'stepNumber';
        let stream = null;
        let currentCamera = 'user';

        const categories = [
            { id: 'etat_initial', name: 'État initial', icon: 'fas fa-flag', description: 'Photos de l\'état initial du chantier' },
            // ... [Vos autres catégories] ...
        ];

        // ==================== IndexedDB ====================
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ChantierPhotosDB', 1);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('photos')) {
                        db.createObjectStore('photos', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('projectInfo')) {
                        db.createObjectStore('projectInfo', { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        async function savePhotos() {
            const db = await openDatabase();
            const tx = db.transaction('photos', 'readwrite');
            const store = tx.objectStore('photos');
            photos.forEach(photo => store.put(photo));
        }

        async function loadSavedData() {
            const db = await openDatabase();
            
            // Charger les photos
            const photosPromise = new Promise((resolve) => {
                const tx = db.transaction('photos', 'readonly');
                const store = tx.objectStore('photos');
                const request = store.getAll();

                request.onsuccess = () => {
                    photos = request.result || [];
                    photoCounter = photos.length > 0 ? Math.max(...photos.map(p => p.id)) : 0;
                    updatePhotoCount();
                    if (photos.length > 0) document.getElementById('exportSection').style.display = 'block';
                    resolve();
                };
            });

            // Charger les infos du projet
            const projectInfoPromise = new Promise((resolve) => {
                const tx = db.transaction('projectInfo', 'readonly');
                const store = tx.objectStore('projectInfo');
                const request = store.get(1);

                request.onsuccess = () => {
                    if (request.result) {
                        document.getElementById('affaire').value = request.result.affaire || '';
                        document.getElementById('code').value = request.result.code || '';
                        document.getElementById('agence').value = request.result.agence || '';
                        document.getElementById('rapportType').value = request.result.rapportType || '';
                        document.getElementById('essais').value = request.result.essais || '';
                        document.getElementById('rmu').value = request.result.rmu || '';
                    }
                    resolve();
                };
            });

            await Promise.all([photosPromise, projectInfoPromise]);
        }

        function saveProjectInfo() {
            const projectInfo = {
                id: 1,
                affaire: document.getElementById('affaire').value,
                code: document.getElementById('code').value,
                agence: document.getElementById('agence').value,
                rapportType: document.getElementById('rapportType').value,
                essais: document.getElementById('essais').value,
                rmu: document.getElementById('rmu').value
            };

            openDatabase().then(db => {
                const tx = db.transaction('projectInfo', 'readwrite');
                const store = tx.objectStore('projectInfo');
                store.put(projectInfo);
            });
        }

        // ==================== Gestion des photos ====================
        async function addPhoto(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const now = new Date();
                    const photo = {
                        id: ++photoCounter,
                        file: file.name,
                        dataUrl: e.target.result,
                        designation: `Photo ${photoCounter}`,
                        filename: file.name,
                        category: 'etat_initial',
                        stepNumber: photoCounter,
                        date: now.toISOString().split('T')[0],
                        time: now.toTimeString().split(' ')[0].slice(0, 5),
                        rotation: 0
                    };
                    photos.push(photo);
                    savePhotos();
                    resolve();
                };
                reader.readAsDataURL(file);
            });
        }

        function removePhoto(photoId) {
            if (confirm('Voulez-vous vraiment supprimer cette photo ?')) {
                photos = photos.filter(p => p.id !== photoId);
                savePhotos();
                
                openDatabase().then(db => {
                    const tx = db.transaction('photos', 'readwrite');
                    const store = tx.objectStore('photos');
                    store.delete(photoId);
                });

                renderPhotos();
                renderCategories();
                updatePhotoCount();
            }
        }

        // ==================== PWA ====================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW enregistré !'))
                    .catch(err => console.log('Échec :', err));
            });
        }

        // ==================== Fonctions existantes ====================
        function updatePhotoCount() {
            const countElement = document.getElementById('photoCount');
            if (countElement) {
                countElement.textContent = `${photos.length} photo${photos.length > 1 ? 's' : ''} importée${photos.length > 1 ? 's' : ''}`;
            }
        }

        function renderCategories() {
            const container = document.getElementById('categoriesGrid');
            const categoriesHTML = categories.map(category => {
                const categoryPhotos = photos.filter(photo => photo.category === category.id);
                const thumbsHTML = categoryPhotos.slice(0, 4).map(photo => 
                    `<img src="${photo.dataUrl}" alt="${photo.designation}" class="category-thumb">`
                ).join('');
                
                return `
                    <div class="category-card ${categoryPhotos.length > 0 ? 'selected' : ''}" 
                         onclick="selectCategory('${category.id}')">
                        <div class="category-header">
                            <div class="category-title">
                                <i class="${category.icon}"></i> ${category.name}
                            </div>
                            <div class="category-count">${categoryPhotos.length}</div>
                        </div>
                        <div class="category-description">${category.description}</div>
                        <div class="category-photos ${categoryPhotos.length === 0 ? 'empty' : ''}">
                            ${categoryPhotos.length === 0 ? 'Aucune photo dans cette catégorie' : thumbsHTML}
                            ${categoryPhotos.length > 4 ? `<div style="color: #7f8c8d; font-size: 0.8em; align-self: center;">+${categoryPhotos.length - 4}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = categoriesHTML;
        }

        // [Continuez avec toutes vos autres fonctions existantes :
        // openCamera(), closeCamera(), capturePhoto(), 
        // renderPhotos(), exportToPDF(), etc.]

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            const photoInput = document.getElementById('photoInput');
            const uploadSection = document.getElementById('uploadSection');
            const captureButton = document.getElementById('captureButton');
            const switchButton = document.getElementById('switchCamera');

            photoInput.addEventListener('change', handleFileSelect);
            
            // Drag & Drop
            uploadSection.addEventListener('dragover', handleDragOver);
            uploadSection.addEventListener('dragleave', handleDragLeave);
            uploadSection.addEventListener('drop', handleDrop);
            
            // Événements pour la caméra
            if (captureButton) captureButton.addEventListener('click', capturePhoto);
            if (switchButton) switchButton.addEventListener('click', switchCamera);

            // Charger les données sauvegardées
            loadSavedData();
            
            // Sauvegarder automatiquement quand les champs changent
            document.querySelectorAll('.project-info-grid input').forEach(input => {
                input.addEventListener('input', saveProjectInfo);
            });
        });
    </script>
</body>
</html>
